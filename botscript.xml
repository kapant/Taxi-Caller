<context>
	<input pattern = "/start" id = "start">
		<output value = "Нужно такси?"/>
		<var name = "RootUserNumber" value = ""/>
		
		<context id = "new_order">
		
		
			<!--новый заказ-->
			<input pattern = "* (да*|верно|ага|так|нужно|сейчас|хочу) *" id = "new_order">
				<var name = "From" value = ""/>
				<var name = "To" value = ""/>
				<var name = "UserNumber" value = "$RootUserNumber"/>
				<var name = "RemNum" value = "0"/>
				
				<!--пункт отправления-->
				<context if = "empty($From)" modal = "true" id = "empty_from">
					<output value = "Откуда едем?"/>
					<input pattern = "[от] $Text" id = "enter_from">
						<var name = "From" value = "$Text"/>
						
						<!--проверка пункта отправления-->
						<get url = "https://geocode-maps.yandex.ru/1.x/" var = "Place">
							<param name = "format" value = "json"/>
							<param name = "geocode" value = "$From"/>
						</get>
						<var name = "GeoFrom">
							<script>
								<![CDATA[
								if ($Place.response.GeoObjectCollection.metaDataProperty.GeocoderResponseMetaData.found != 0) {
									$Place.response.GeoObjectCollection.featureMember[0].GeoObject.metaDataProperty.GeocoderMetaData.text;
								} else {
									"";
								}
								]]>
							</script>
						</var>
						<context if = "empty($GeoFrom)" modal = "true">
							<output value = "Извините, адрес не найден. Пожалуйста, повторите ввод."/>
							<input id = "enter_from"/>
						</context>
						
						<context if = "empty($To)" id = "empty_to" modal = "true"/>
						<context if = "empty($UserNumber)" id = "empty_number" modal = "true"/>
						<context id = "done"/>
					</input>
					<input pattern = "* (отмена|стоп) *">
						<output value = "Заказ отменен. Дайте знать, когда захотите сделать новый."/>
						<context id = "new_order"/>
					</input>
				</context>
				
				<!--пункт назначения-->
				<context if = "empty($To)" modal = "true" id = "empty_to">
					<output value = "Куда едем?"/>
					<input pattern = "[к|до|на] $Text" id = "enter_to">
						<var name = "To" value = "$Text"/>
						
						<!--проверка пункта назначения-->
						<get url = "https://geocode-maps.yandex.ru/1.x/" var = "Place">
							<param name = "format" value = "json"/>
							<param name = "geocode" value = "$To"/>
						</get>
						<var name = "GeoTo">
							<script>
								<![CDATA[
								if ($Place.response.GeoObjectCollection.metaDataProperty.GeocoderResponseMetaData.found != 0) {
									$Place.response.GeoObjectCollection.featureMember[0].GeoObject.metaDataProperty.GeocoderMetaData.text;
								} else {
									"Адрес не найден";
								}
								]]>
							</script>
						</var>
						<context if = "empty($GeoTo)">
							<output value = "Извините, адрес не найден. Пожалуйста, повторите ввод."/>
							<input id = "enter_to"/>
						</context>
					
						<context if = "empty($UserNumber)" id = "empty_number"/>
						<context id = "done"/>
					</input>
					<input pattern = "* (отмена|стоп) *">
						<output value = "Заказ отменен. Дайте знать, когда захотите сделать новый."/>
						<context id = "new_order"/>
					</input>
				</context>
				
				<!--номер-->
				<context if = "empty($UserNumber)" modal = "true" id = "empty_number">
					<output value = "На какой номер сделать заказ?"/>
					<input pattern = "$Text" id = "enter_number">
						<var name= "UserNumber" value = "$Text"/>
						
						<!--проверка номера-->
						<var name = "Err">
							<script>
								<![CDATA[
								var flag = 0;
								if ($UserNumber.length <= 13 && $UserNumber.length >= 10) {
									for (var i = 2; i < $UserNumber.length; i++) {
										if ($UserNumber[i] < '0' || $UserNumber[i] > '9') {
											flag = 1;
											break;
										}
									}
								} else {
									flag = 1;
								}
								flag;
								]]>
							</script>
						</var>
						<context if = '$Err == 1'>
							<output value = "Номер введен неверно, пожалуйста, введите еще раз."/>
							<input id = "enter_number"/>
						</context>
						<context if = '$Err == 0'>
							<output value = "Запомнить номер?"/>
							<input pattern = "* [да*|верно|ага|так|запомн*] *">
								<var name = "RemNum" value = "1"/>
								<context id = "done"/>
							</input>
							<input pattern = "*">
								<var name = "RemNum" value = "0"/>
								<context id = "done"/>
							</input>
							<input pattern = "* (отмена|стоп) *">
								<output value = "Заказ отменен. Дайте знать, когда захотите сделать новый."/>
								<context id = "new_order"/>
							</input>
						</context>
						
					</input>
					<input pattern = "* (отмена|стоп) *">
						<output value = "Заказ отменен. Дайте знать, когда захотите сделать новый."/>
						<context id = "new_order"/>
					</input>
				</context>
				
				<!--проверка закакза-->
				<context id = "done">
					
					<!--подтверждение заказа-->
					<output value = "Нужно такси от $GeoFrom до $GeoTo на номер $UserNumber, верно?"/>
					<input pattern = "* [да|верно|ага|так] *">
						<output value = "Обработка. сделать новый закказ?"/>
						<var name = "From" value = ""/>
						<var name = "To" value = ""/>
						<context if = '$RemNum == "1"'>
							<var name = "RootUserNumber" value = "$UserNumber"/>
						</context>
						<var name = "UserNumber" value = ""/>
						<context>
							<input pattern = "* [да*|верно|ага|так|сдела*] *">
								<output value = "Откуда едем?"/>
								<context id = "empty_from"/>
							</input>
							<input pattern = "*">
								<output value = "Дайте знать, когда захотите вызвать такси."/>
								<context id = "new_order"/>
							</input>
						</context>
					</input>
					<input pattern = "*">
						<output value = "Что именно неверно?"/>
						<context>
							<input pattern = "* (отмена|стоп) *">
								<output value = "Заказ отменен. Дайте знать, когда захотите сделать новый."/>
								<context id = "new_order"/>
							</input>
							<input pattern = "$Text">
								<context if = 'has($Text, "подач") or has($Text, "отправлен") or has($Text, "откуда")' id = "empty_from"/>
								<context if = 'has($Text, "назначен") or has($Text, "куда")' id = "empty_to"/>
								<context if = 'has($Text, "номер")' id = "empty_number"/>
							</input>
						</context>
					</input>
					<input pattern = "* (отмена|стоп) *">
						<output value = "Заказ отменен. Дайте знать, когда захотите сделать новый."/>
						<context id = "new_order"/>
					</input>
					
				</context>
			</input>
			
			<input pattern = "/help">
				<output value = "Помощь. Тра-та-та. Нужно такси?"/>
				<context id = "new_order"/>
			</input>
			
			<input pattern = "*">
				<output value = "Дайте знать, когда будет нужно такси."/>
				<context id = "new_order"/>
			</input>
		
		</context>
	</input>
</context>
