<context>
	<input pattern = "/start" id = "start">

		<var name = "RootUserNumber" value = "" scope = "user"/>
		
		<output value = "Нужно такси?"/>
		
		
		<context id = "new_order">	
		
			<var name = "From" value = "" scope = "user"/>
			<var name = "To" value = "" scope = "user"/>
			<var name = "UserNumber" value = "$RootUserNumber" scope = "user"/>
			<var name = "GeoFrom" value = "" scope = "user"/>
			<var name = "GeoTo" value = "" scope = "user"/>
			
			<!--новый заказ-->
			<input pattern = "* (да*|верно|ага|так|нужн*|сейчас|хочу) *" id = "new_order">
				
				<!--пункт отправления-->
				<context if = "empty($From)" modal = "true" id = "empty_from">
					<output value = "Откуда едем?"/>
					<input pattern = "[от] $Text" id = "enter_from">
						<var name = "From" value = "$Text" scope = "user"/>
						
						<!--проверка пункта отправления-->
						<get url = "https://geocode-maps.yandex.ru/1.x/" var = "Place">
							<param name = "format" value = "json"/>
							<param name = "geocode" value = "$From"/>
						</get>
						<var name = "GeoFrom" scope = "user">
							<script>
								<![CDATA[
								if ($Place.response.GeoObjectCollection.metaDataProperty.GeocoderResponseMetaData.found != 0) {
									$Place.response.GeoObjectCollection.featureMember[0].GeoObject.metaDataProperty.GeocoderMetaData.text;
								} else {
									"";
								}
								]]>
							</script>
						</var>
						<context if = "empty($GeoFrom)" id = "empty_from" modal = "true"/>
						
						<context if = "empty($To)" id = "empty_to"/>
						<context if = "empty($UserNumber)" id = "empty_number"/>
						<context id = "done"/>
					</input>
					<input pattern = "* (отмена|стоп) *">
						<var name = "From" value = "" scope = "user"/>
						<var name = "To" value = "" scope = "user"/>
						<var name = "UserNumber" value = "$RootUserNumber" scope = "user"/>
						<output value = "Заказ отменен. Дайте знать, когда захотите сделать новый."/>
						<context id = "new_order"/>
					</input>
				</context>
				
				<!--пункт назначения-->
				<context if = "empty($To)" modal = "true" id = "empty_to">
					<output value = "Куда едем?"/>
					<input pattern = "[к|до|на] $Text" id = "enter_to">
						<var name = "To" value = "$Text"  scope = "user"/>
						
						<!--проверка пункта назначения-->
						<get url = "https://geocode-maps.yandex.ru/1.x/" var = "Place">
							<param name = "format" value = "json"/>
							<param name = "geocode" value = "$To"/>
						</get>
						<var name = "GeoTo"  scope = "user">
							<script>
								<![CDATA[
								if ($Place.response.GeoObjectCollection.metaDataProperty.GeocoderResponseMetaData.found != 0) {
									$Place.response.GeoObjectCollection.featureMember[0].GeoObject.metaDataProperty.GeocoderMetaData.text;
								} else {
									"";
								}
								]]>
							</script>
						</var>
						<context if = "empty($GeoTo)" modal = "true" id = "empty_to"/>
					
						<context if = "empty($UserNumber)" id = "empty_number"/>
						<context id = "done"/>
					</input>
					<input pattern = "* (отмена|стоп) *">
						<var name = "From" value = "" scope = "user"/>
						<var name = "To" value = "" scope = "user"/>
						<var name = "UserNumber" value = "$RootUserNumber" scope = "user"/>
						<output value = "Заказ отменен. Дайте знать, когда захотите сделать новый."/>
						<context id = "new_order"/>
					</input>
				</context>
				
				<!--номер-->
				<context if = "empty($UserNumber)" modal = "true" id = "empty_number">
					<output value = "На какой номер сделать заказ?"/>
					<input pattern = "$Text" id = "enter_number">
						<var name= "UserNumber" scope = "user">
							<script>
								<![CDATA[
									$Text.replace(/ /g, "");
								]]>
							</script>
						</var>
						
						<!--проверка номера-->
						<var name = "Err">
							<script>
								<![CDATA[
								var flag = 0;
								$UserNumber = $UserNumber.replace(/ /g, "");
								if ($UserNumber.length <= 12 && $UserNumber.length > 10) {
									for (var i = 1; i < $UserNumber.length; i++) {
										if ($UserNumber[i] < '0' || $UserNumber[i] > '9') {
											flag = 1;
											break;
										}
									}
								} else {
									flag = 1;
								}
								flag;
								]]>
							</script>
						</var>
						<context if = '$Err == 1' id = "empty_number"/>
						
						<context if = '$Err == 0'>
							<output value = "Запомнить номер?"/>
							<input pattern = "* (да*|верно|ага|так|запомн*) *">
								<var name = "RootUserNumber" value = "$UserNumber" scope = "user"/>
								<context id = "done"/>
							</input>
							<input pattern = "*">
								<context id = "done"/>
							</input>
							<input pattern = "* (отмена|стоп) *">
								<var name = "From" value = "" scope = "user"/>
								<var name = "To" value = "" scope = "user"/>
								<var name = "UserNumber" value = "$RootUserNumber" scope = "user"/>
								<output value = "Заказ отменен. Дайте знать, когда захотите сделать новый."/>
								<context id = "new_order"/>
							</input>
						</context>
						
					</input>
					<input pattern = "* (отмена|стоп) *">
						<var name = "From" value = "" scope = "user"/>
						<var name = "To" value = "" scope = "user"/>
						<var name = "UserNumber" value = "$RootUserNumber" scope = "user"/>
						<output value = "Заказ отменен. Дайте знать, когда захотите сделать новый."/>
						<context id = "new_order"/>
					</input>
				</context>
				
				<!--проверка закакза-->
				<context id = "done">
					
					<!--подтверждение заказа-->
					<output value = "Нужно такси от $GeoFrom до $GeoTo на номер $UserNumber, верно?"/>
					<input pattern = "* (да|верно|ага|так) *">
						<var name = "From" value = "" scope = "user"/>
						<var name = "To" value = "" scope = "user"/>
						<var name = "UserNumber" value = "$RootUserNumber" scope = "user"/>
						<context id = "next">							
							
							<var name = "GeoFrom" scope = "user">
								<script>
									<![CDATA[
										$GeoFrom.replace(/ /g, "%20");
									]]>
								</script>
							</var>
							
							<var name = "GeoTo" scope = "user">
								<script>
									<![CDATA[
										$GeoTo.replace(/ /g, "%20");
									]]>
								</script>
							</var>
							
							<output value = "$GeoFrom $GeoTo"/>
							
							<get value = "https://taxi.yandex.ru/" var = "Place">
								<param name = "gfrom" value = "$GeoFrom"/>
								<param name = "gto" value = "$GeoTo"/>
								<param name = "phone" value = "$UserNumber"/>
							</get>
							<!--<output value = "Такси скоро приедет. сделать новый заказ?"/>-->
							<input pattern = "* (да*|верно|ага|так|сдела*) *">
								<output value = "Откуда едем?"/>
								<context id = "empty_from"/>
							</input>
							<input pattern = "*">
								<output value = "Дайте знать, когда захотите вызвать такси."/>
								<context id = "new_order"/>
							</input>
						</context>
					</input>
					<input pattern = "*">
						<output value = "Что именно неверно?"/>
						<context>
							<input pattern = "* (отмена|стоп) *">
								<var name = "From" value = "" scope = "user"/>
								<var name = "To" value = "" scope = "user"/>
								<var name = "UserNumber" value = "$RootUserNumber" scope = "user"/>
								<output value = "Заказ отменен. Дайте знать, когда захотите сделать новый."/>
								<context id = "new_order"/>
							</input>
							<input pattern = "$Text">
								<context if = 'has($Text, "подач") or has($Text, "отправлен") or has($Text, "откуда")' id = "empty_from"/>
								<context if = 'has($Text, "назначен") or has($Text, "куда")' id = "empty_to"/>
								<context if = 'has($Text, "номер")' id = "empty_number"/>
							</input>
						</context>
					</input>
					<input pattern = "* (отмена|стоп) *">
						<var name = "From" value = "" scope = "user"/>
						<var name = "To" value = "" scope = "user"/>
						<var name = "UserNumber" value = "$RootUserNumber" scope = "user"/>
						<output value = "Заказ отменен. Дайте знать, когда захотите сделать новый."/>
						<context id = "new_order"/>
					</input>
					
				</context>
			</input>
			
			<input pattern = "/help">
				<output value = "Помощь. Тра-та-та. Нужно такси?"/>
				<context id = "new_order"/>
			</input>
			
			<input pattern = "*">
				<output value = "Дайте знать, когда будет нужно такси."/>
				<context id = "new_order"/>
			</input>
		
		</context>
	</input>
</context>
