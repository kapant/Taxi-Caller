<context>
	<input pattern = "/start" id = "start">
		<output value = "Нужно такси?"/>
		<var name = "UserNumber" value = ""/>
		
		<context id = "new_order">
		
		
		<!--новый заказ-->
		<input pattern = "* (да*|верно|ага|так|нужно|сейчас) *" id = "new_order">
			<var name = "From" value = ""/>
			<var name = "To" value = ""/>
			<var name = "RemNum" value = "0"/>
			
			<!--пункт отправления-->
			<context if = "empty($From)" modal = "true" id = "empty_from">
				<output value = "Откуда едем?"/>
				<input pattern = "[от] $Text" id = "enter_from">
					<var name = "From" value = "$Text"/>
					<context if = "empty($To)" id = "empty_to"/>
					<context if = "empty($UserNumber)" id = "empty_number"/>
					<context id = "done"/>
				</input>
			</context>
			
			<!--пункт назначения-->
			<context if = "empty($To)" modal = "true" id = "empty_to">
				<output value = "Куда едем?"/>
				<input pattern = "[к|до|на] $Text" id = "enter_to">
					<var name = "To" value = "$Text"/>
					<context if = "empty($UserNumber)" id = "empty_number"/>
					<context id = "done"/>
				</input>
			</context>
			
			<!--номер-->
			<context if = "empty($UserNumber)" modal = "true" id = "empty_number">
				<output value = "На какой номер сделать заказ?"/>
				<input pattern = "$Text" id = "enter_number">
					<var name= "UserNumber" value = "$Text"/>
					
					<!--проверка номера-->
					<var name = "Err">
						<script>
							<![CDATA[
							var flag = 0;
							if ($UserNumber.length <= 13) {
								for (var i = 2; i < $UserNumber.length; i++) {
									if ($UserNumber[i] < '0' || $UserNumber[i] > '9') {
										flag = 1;
										break;
									}
								}
							} else {
								flag = 1;
							}
							flag;
							]]>
						</script>
					</var>
					<context if = '$Err == 1'>
						<output value = "Номер введен неверно, пожалуйста, введите еще раз."/>
						<input id = "enter_number"/>
					</context>
					<context if = '$Err == 0'>
						<output value = "Запомнить номер?"/>
						<input pattern = "* [да*|верно|ага|так|запомн*] *">
							<var name = "RemNum" value = "1"/>
							<context id = "done"/>
						</input>
						<input pattern = "* (не*) *">
							<var name = "RemNum" value = "0"/>
							<context id = "done"/>
						</input>
					</context>
					
				</input>
			</context>
			
			<!--проверка закакза-->
			<context id = "done">
				
				<!--проверка пункта назначения-->
				<get url = "https://geocode-maps.yandex.ru/1.x/" var = "Place">
					<param name = "format" value = "json"/>
					<param name = "geocode" value = "$From"/>
				</get>
				<var name = "GeoFrom">
					<script>
						<![CDATA[
						if ($Place.response.GeoObjectCollection.metaDataProperty.GeocoderResponseMetaData.found != 0) {
							//$Place.response.GeoObjectCollection.featureMember[0].GeoObject.metaDataProperty.GeocoderMetaData.text;
						} else {
							"Адрес не найден";
						}
						]]>
					</script>
				</var>
				
				<!--проверка пункта отправления-->
				<get url = "https://geocode-maps.yandex.ru/1.x/" var = "Place">
					<param name = "format" value = "json"/>
					<param name = "geocode" value = "$To"/>
				</get>
				<var name = "GeoTo">
					<script>
						<![CDATA[
						if ($Place.response.GeoObjectCollection.metaDataProperty.GeocoderResponseMetaData.found != 0) {
							//$Place.response.GeoObjectCollection.featureMember[0].GeoObject.metaDataProperty.GeocoderMetaData.text;
						} else {
							"Адрес не найден";
						}
						]]>
					</script>
				</var>
				
				<!--подтверждение заказа-->
				<output value = "Нужно такси от $GeoFrom до $GeoTo на номер $UserNumber, верно?"/>
				<input pattern = "* [да|верно|ага|так] *">
					<output value = "Обработка. сделать новый закказ?"/>
					<var name = "From" value = ""/>
					<var name = "To" value = ""/>
					<context if = '$RemNum == "0"'>
						<var name = "UserNumber" value = ""/>
					</context>
					<context>
						<input pattern = "* [да*|верно|ага|так|сдела*] *">
							<output value = "Откуда едем?"/>
							<context id = "empty_from"/>
						</input>
						<input pattern = "* (не*) *" id = "start">
							<output value = "Дайте знать, когда будет нужно."/>
							<context id = "new_order"/>
						</input>
					</context>
				</input>
				<input pattern = "* (не*) *">
					<output value = "Что именно неверно?"/>
					<context>
						<input pattern = "$Text">
							<context if = 'has($Text, "подач") or has($Text, "отправлен") or has($Text, "откуда")' id = "empty_from"/>
							<context if = 'has($Text, "назначен") or has($Text, "куда")' id = "empty_to"/>
							<context if = 'has($Text, "номер")' id = "empty_number"/>
						</input>
					</context>
				</input>
				
			</context>
		</input>
		
		<input pattern = "*">
			<output value = "Дайте знать, когда будет нужно."/>
			<context id = "new_order"/>
		</input>
		
		</context>
	</input>
</context>
